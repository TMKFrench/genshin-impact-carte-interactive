function onMapClick(e){console.log("Position @ "+map.project([e.latlng.lat,e.latlng.lng],map.getMaxZoom())),console.log("Point @ ["+e.latlng.lat+", "+e.latlng.lng+"]")}function unproject(coord){return map.unproject(coord,map.getMaxZoom())}function updateCurrentMarker(){currentMarker=this}function updateUserCountdowns(checked){var countdowns=getUserCountdowns();if(void 0!==currentMarker._tooltip&&"countdown"===currentMarker._tooltip.options.className){var cid=currentMarker._tooltip.options.countdownid;if(checked){var nextTime=moment();nextTime.add(currentMarker._tooltip.options.countdown,"hours"),currentMarker._tooltip.setContent('<div id="countdown-'+currentMarker._tooltip.options.countdownid+'">Prochain reset :</div>'),$($("#countdown-"+currentMarker._tooltip.options.countdownid)).countdown(nextTime.toDate(),(function(event){var totalDays;"finish"===event.type?(resetCountdown(cid),$(this).html("")):7*event.offset.weeks+event.offset.days>0?$(this).html("Prochain reset :<br />"+event.strftime("%-D j. %H:%M:%S")):$(this).html("Prochain reset :<br />"+event.strftime("%H:%M:%S"))})),searchId(cid,countdowns)<=0&&countdowns.push({id:cid,date:nextTime.format("YYYY-MM-DD HH:mm:ss")})}else{var i=searchId(cid,countdowns);i>=0&&countdowns.splice(i,1),currentMarker._tooltip.setContent('<div id="countdown-'+currentMarker._tooltip.options.countdownid+'"></div>')}localStorage.setItem("userCountdowns",JSON.stringify(countdowns)),userCountdowns=JSON.stringify(countdowns)}}function saveUserMarker(uid,checked){var markers=getUserMarkers();updateUserCountdowns(checked),checked?$.post("api/addmarker/"+uid,(function(res){void 0!==res.error&&(alert("Vous avez été déconnecté. La page va se rafraîchir."),window.location.reload()),currentMarker.setOpacity(.5),userMarkers=res.markers})):$.post("api/removemarker/"+uid,(function(res){void 0!==res.error&&(alert("Vous avez été déconnecté. La page va se rafraîchir."),window.location.reload()),currentMarker.setOpacity(1),userMarkers=res.markers}))}function searchId(nameKey,myArray){for(var i=0;i<myArray.length;i++)if(myArray[i].id===nameKey)return i;return-1}function resetCountdown(cid){var markers=getUserMarkers(),countdowns=getUserCountdowns(),i=searchId(cid,countdowns);i>=0&&(allMarkers[cid].setOpacity(1),countdowns.splice(i,1)),markers.indexOf(cid)>=0&&markers.splice(markers.indexOf(cid),1),localStorage.setItem("userCountdowns",JSON.stringify(countdowns)),userCountdowns=JSON.stringify(countdowns),localStorage.setItem("userMarkers",JSON.stringify(markers)),userMarkers=JSON.stringify(markers)}function saveUserMarkers(uid,checked){var markers=getUserMarkers();updateUserCountdowns(checked),checked?(markers.indexOf(uid)<0&&markers.push(uid),currentMarker.setOpacity(.5)):(markers.indexOf(uid)>=0&&markers.splice(markers.indexOf(uid),1),currentMarker.setOpacity(1)),localStorage.setItem("userMarkers",JSON.stringify(markers)),userMarkers=JSON.stringify(markers)}function updateislandmarkers(ileId,ilever,old){hidelayer=window["l"+ileId+old],hidelayer.forEach((function(e){map.removeLayer(window[ileId+old+e+"Group"])})),showlayer=window["l"+ileId+ilever],window.menuActive.forEach((function(e){showlayer.indexOf(e)>=0&&map.addLayer(window[ileId+ilever+e+"Group"])}))}function updateislandmarkersmenu(type,add){for(let i=1;i<4;i++)currentver=window["oldile"+i],window["lile"+i+currentver].indexOf(type)>=0&&(add?map.addLayer(window["ile"+i+currentver+type+"Group"]):map.removeLayer(window["ile"+i+currentver+type+"Group"]))}function updateislandmarkersinit(){for(let i=1;i<4;i++)window.menuActive.forEach((function(e){window["lile"+i+"1"].indexOf(e)>=0&&map.addLayer(window["ile"+i+"1"+e+"Group"])}))}function getUserCountdowns(){var countdowns=localStorage.getItem("userCountdowns");return countdowns=countdowns?JSON.parse(countdowns):[]}function getUserMarkers(){var markers=localStorage.getItem("userMarkers");return markers=markers?JSON.parse(markers):[]}function getParamsURL(){var url,query=location.search.substr(1),result={};return query.split("&").forEach((function(part){var item=part.split("=");result[item[0]]=decodeURIComponent(item[1])})),result}function popUpOpen(e){var content=e.popup.getContent();$(content).find("input#user-marker").length>0&&userMarkers.indexOf($(content).find("input#user-marker").first().data("id"))>=0&&$('input#user-marker[data-id="'+$(content).find("input#user-marker").first().data("id")+'"]').prop("checked","checked")}function popUpOpen2(e){var content=e.popup.getContent();island=$(content).find("input.item-ile").first().data("id"),$('input[data-id="'+island+'"][data-ver="'+window["old"+island]+'"]').prop("checked","checked")}var currentMarker,total=0,params=getParamsURL(),userMarkers=getUserMarkers(),userCountdowns=getUserCountdowns(),debugMarkers=[],userLocal=!0,allMarkers=[],oldile1=1,oldile2=1,oldile3=1,menuActive=[],lile11=["challenge"],lile12=["challenge","animauxtranslucide"],lile13=["challenge","animauxtranslucide"],lile14=["challenge","animauxtranslucide"],lile15=["challenge"],lile16=["challenge","animauxtranslucide"],lile17=["challenge","animauxtranslucide"],lile18=["challenge"],lile19=["challenge","animauxtranslucide"],lile21=["challenge","animauxtranslucide"],lile22=["challenge","animauxtranslucide"],lile31=["challenge","animauxtranslucide"],lile32=["challenge","animauxtranslucide"],map=new L.Map("map",{center:[5,-15],zoom:3,zoomControl:!1});L.tileLayer("assets/img/tiles-summer22/{z}/{x}/{y}.png",{attribution:'<a href="https://gaming.lebusmagique.fr">Le Bus Magique Gaming</a>',maxZoom:5,minZoom:2,continuousWorld:!0,maxBoundsViscosity:.8,noWrap:!0}).addTo(map);var latLngBoundsile1=L.latLngBounds([unproject([4953,4493])],[unproject([5774,5181])]),latLngBoundsile2=L.latLngBounds([unproject([3186,5113])],[unproject([4706,6054])]),latLngBoundsile3=L.latLngBounds([unproject([2840,3113])],[unproject([4114,4054])]);for(let i=1;i<10;i++)window["imageOverlayile1"+i]=L.imageOverlay("assets/img/tiles-summer22/ile1-"+i+".png",latLngBoundsile1);for(let i=1;i<3;i++)window["imageOverlayile2"+i]=L.imageOverlay("assets/img/tiles-summer22/ile2-"+i+".png",latLngBoundsile2);for(let i=1;i<3;i++)window["imageOverlayile3"+i]=L.imageOverlay("assets/img/tiles-summer22/ile3-"+i+".png",latLngBoundsile3);imageOverlayile11.addTo(map),imageOverlayile21.addTo(map),imageOverlayile31.addTo(map);var toolbarZoom=L.easyBar([L.easyButton('<img src="assets/img/plus.png" alt="Zoom+" title="Zoomer sur la carte">',(function(control,map){map.setZoom(map.getZoom()+1)})),L.easyButton('<img src="assets/img/minus.png" alt="Zoom-" title="Dézoomer sur la carte">',(function(control,map){map.setZoom(map.getZoom()-1)}))]),toolbarMenu=L.easyBar([L.easyButton('<img src="assets/img/menu.png" alt="Menu" title="Afficher/Masquer le menu">',(function(control,map){$("body").toggleClass("show-menu"),map.invalidateSize()}))]),toolbarRegion=L.easyBar([L.easyButton('<img src="assets/img/region.png" alt="Region" title="Afficher/Masquer le nom des régions">',(function(control,map){map.hasLayer(regionGroup)?map.removeLayer(regionGroup):map.addLayer(regionGroup)}))]),toolbarResetMarkers=L.easyBar([L.easyButton('<img src="assets/img/reset.png" alt="Réinitialiser" title="Réinitialiser le suivi de vos marqueurs">',(function(control,map){confirm("Êtes-vous sûr de vouloir supprimer le suivi de vos marqueurs ?")&&(userLocal?(localStorage.removeItem("userMarkers"),localStorage.removeItem("userCountdowns"),window.location.reload()):$.post("api/resetmarkers",(function(res){void 0!==res.error&&alert("Vous avez été déconnecté. La page va se rafraîchir."),localStorage.removeItem("userMarkers"),localStorage.removeItem("userCountdowns"),window.location.reload()})))}))]),toolbarInfo=L.easyBar([L.easyButton('<img src="assets/img/info.png">',(function(control,map){var lightbox=lity("#info")}))]);function initMarkers(){markers.forEach((function(g){g.markers.forEach((function(m){var checkbox="",icon,format,title="",text="",guide="",countdown,timer,finished=!1,color="#3388ff",region;(void 0!==m.checkbox&&m.checkbox||void 0!==g.checkbox&&g.checkbox)&&(checkbox='<label><input type="checkbox" id="user-marker" data-id="summer22'+g.id+m.id+'" /><span>Terminé</span></label>'),void 0!==g.text&&(text="<p>"+g.text+"</p>"),void 0!==m.text&&(text="<p>"+m.text+"</p>"),void 0!==g.title&&(title="<h4>"+g.title+"</h4>"),void 0!==m.title&&(title="<h4>"+m.title+"</h4>"),void 0!==g.guide&&(guide='<a href="'+g.guide+'" class="guide" target="_blank">Guide</a>'),void 0!==m.guide&&(guide=void 0!==g.guide&&"#"===m.guide.substr(0,1)?'<a href="'+g.guide+m.guide+'" class="guide" target="_blank">Guide</a>':'<a href="'+m.guide+'" class="guide" target="_blank">Guide</a>'),icon=void 0!==m.icon?m.icon:g.icon,format=void 0!==m.format?m.format:g.format,void 0!==g.countdown&&(countdown=g.countdown),void 0!==m.countdown&&(countdown=m.countdown),void 0!==g.timer&&(timer=g.timer),void 0!==m.timer&&(timer=m.timer),void 0!==g.color&&(color=g.color),void 0!==m.color&&(color=m.color),region=void 0!==g.region?g.region:void 0!==m.region?m.region:"base";var marker=L.marker(unproject([m.coords[0],m.coords[1]]),{icon:icon,riseOnHover:!0});if("popup"===format?marker.bindPopup(title+text+guide+checkbox,{className:"normpop"}):"video"===format?marker.bindPopup(title+'<a class="video" href="//www.youtube.com/watch?v='+m.video+'" data-lity><img src="https://i.ytimg.com/vi/'+m.video+'/hqdefault.jpg" /></a>'+text+guide+checkbox,{className:"normpop"}):"image"===format?marker.bindPopup(title+'<a href="assets/img/medias/sum22'+g.id+m.id+'.jpg" class="image" data-lity><img src="thumb/sum22'+g.id+m.id+'" /></a>'+text+guide+checkbox,{className:"normpop"}):"banner"===format?marker.bindPopup(title+'<img src="assets/img/medias/sum22'+g.id+m.id+'.jpg" onerror="this.src=\'assets/img/medias/default.jpg\'" />'+text+guide+checkbox,{className:"normpop"}):"region"===format?marker.bindTooltip(m.title,{permanent:!0,className:"region",offset:[0,13],direction:"top"}).openTooltip():"todo"===format?marker.bindPopup("<h4>sum22"+g.id+m.id+"</h4><p><em>Information pour ce marqueur prochainement disponible...</em></p>"+checkbox,{className:"normpop"}):"gif"===format&&marker.bindPopup(title+'<a href="assets/img/medias/sum22'+g.id+m.id+'.gif" class="image" data-lity><img src="assets/img/medias/sum22'+g.id+m.id+'.gif" /></a>'+text+guide+checkbox,{className:"normpop"}),void 0!==timer){var nextTime=moment();nextTime.get("hour")>=4&&nextTime.add(1,"day"),nextTime.set({hour:4,minute:0,second:0,millisecond:0}),marker.bindTooltip('<div id="timer-'+g.id+m.id+'">Prochain reset :</div>',{timerid:g.id+m.id,timer:nextTime.toDate(),permanent:!0,className:"timer",offset:[0,0],direction:"bottom"}).openTooltip(),marker.on("tooltipopen",(function(e){$($("#timer-"+e.tooltip.options.timerid)).countdown(e.tooltip.options.timer,(function(event){$(this).html("Prochain reset :<br />"+event.strftime("%H:%M:%S"))}))}))}if(void 0!==countdown){marker.bindTooltip("",{countdownid:g.id+m.id,countdown:countdown,permanent:!0,className:"countdown",offset:[0,10],direction:"bottom"}).openTooltip();var i=searchId(g.id+m.id,userCountdowns);i>=0&&(marker._tooltip.setContent('<div id="countdown-'+g.id+m.id+'">Prochain reset :</div>'),marker.on("tooltipopen",(function(e){$($("#countdown-"+g.id+m.id)).countdown(userCountdowns[i].date,(function(event){var totalDays;"finish"===event.type?(resetCountdown(g.id+m.id),$(this).html("")):7*event.offset.weeks+event.offset.days>0?$(this).html("Prochain reset :<br />"+event.strftime("%-D j. %H:%M:%S")):$(this).html("Prochain reset :<br />"+event.strftime("%H:%M:%S"))}))})))}if(checkbox&&marker.on("click",updateCurrentMarker),void 0!==m.polygon)var polygon=L.polygon(m.polygon,{color:color,fillColor:color}).addTo(g.group);marker.addTo(g.group),total++,userMarkers.indexOf("summer22"+g.id+m.id)>=0&&marker.setOpacity(.5),params.debug&&"region"!==g.id&&debugMarkers.push({name:g.id+m.id,marker:marker,coords:m.coords,icon:icon}),allMarkers[g.id+m.id]=marker}))})),$("#total").text(total)}toolbarZoom.addTo(map),toolbarMenu.addTo(map),toolbarRegion.addTo(map),toolbarResetMarkers.addTo(map),toolbarInfo.addTo(map),L.marker(unproject([5404,4550]),{icon:layersIcon,riseOnHover:!0}).on("click",updateCurrentMarker).bindTooltip("Changer la configuration de l'île",{offset:[20,0],direction:"right"}).bindPopup('<form><input type="radio" class="item-ile radioile" id="ile11" name="configile1" data-id="ile1" data-ver="1"><label for="ile11"><span><img src="assets/img/config11.png" /> Rocaille sereine + Rocaille sereine</span></label><br><input type="radio" class="radioile" id="ile12" name="configile1" data-id="ile1" data-ver="2"><label for="ile12"><span><img src="assets/img/config12.png" /> Rocaille sereine + Rocaille lumineuse</span></label><br><input type="radio" class="radioile" id="ile13" name="configile1" data-id="ile1" data-ver="3"><label for="ile13"><span><img src="assets/img/config13.png" /> Rocaille sereine + Rocaille inflexible</span></label><br><input type="radio" class="radioile" id="ile14" name="configile1" data-id="ile1" data-ver="4"><label for="ile14"><span><img src="assets/img/config14.png" /> Rocaille lumineuse + Rocaille sereine</span></label><br><input type="radio" class="radioile" id="ile15" name="configile1" data-id="ile1" data-ver="5"><label for="ile15"><span><img src="assets/img/config15.png" /> Rocaille lumineuse + Rocaille lumineuse</span></label><br><input type="radio" class="radioile" id="ile16" name="configile1" data-id="ile1" data-ver="6"><label for="ile16"><span><img src="assets/img/config16.png" /> Rocaille lumineuse + Rocaille inflexible</span></label><br><input type="radio" class="radioile" id="ile17" name="configile1" data-id="ile1" data-ver="7"><label for="ile17"><span><img src="assets/img/config17.png" /> Rocaille inflexible + Rocaille sereine</span></label><br><input type="radio" class="radioile" id="ile18" name="configile1" data-id="ile1" data-ver="8"><label for="ile18"><span><img src="assets/img/config18.png" /> Rocaille inflexible + Rocaille lumineuse</span></label><br><input type="radio" class="radioile" id="ile19" name="configile1" data-id="ile1" data-ver="9"><label for="ile19"><span><img src="assets/img/config19.png" /> Rocaille inflexible + Rocaille inflexible</span></label></form>',{maxHeight:350,minWidth:350,className:"radiopop"}).on("popupopen",popUpOpen2).addTo(map),L.marker(unproject([4206,5318]),{icon:layersIcon,riseOnHover:!0}).on("click",updateCurrentMarker).bindTooltip("Changer la configuration de l'île",{offset:[20,0],direction:"right"}).bindPopup('<form><input type="radio" class="item-ile radioile" id="ile21" name="configile2" data-id="ile2" data-ver="1"><label for="ile21"><span><img src="assets/img/config21.png" /> Îles funestes - Configuration 1</span></label><br><input type="radio" class="radioile" id="ile22" name="configile2" data-id="ile2" data-ver="2"><label for="ile22"><span><img src="assets/img/config22.png" /> Îles funestes - Configuration 2</span></label></form>',{maxHeight:350,minWidth:350,className:"radiopop"}).on("popupopen",popUpOpen2).addTo(map),L.marker(unproject([3688,3812]),{icon:layersIcon,riseOnHover:!0}).on("click",updateCurrentMarker).bindTooltip("Changer la configuration de l'île",{offset:[20,0],direction:"right"}).bindPopup('<form><input type="radio" class="item-ile radioile" id="ile31" name="configile3" data-id="ile3" data-ver="1"><label for="ile31"><span><img src="assets/img/config31.png" /> Îles brisées - Montagnes hautes</span></label><br><input type="radio" class="radioile" id="ile32" name="configile3" data-id="ile3" data-ver="2"><label for="ile32"><span><img src="assets/img/config32.png" /> Îles brisées - Montagnes basses</span></label></form>',{maxHeight:350,minWidth:350,className:"radiopop"}).on("popupopen",popUpOpen2).addTo(map),map.setMaxBounds(new L.LatLngBounds(unproject([0,0]),unproject([8192,8192]))),map.on("click",onMapClick),groups.forEach((function(e){map.removeLayer(window[e+"Group"])})),params.debug&&(initMarkers(),$("#menu ul").html(""),debugMarkers.forEach((function(m,k){$("#menu ul").append('<li class="marker col-span-2"><a href="#" data-debug-marker="'+m.name+'" class="active"><img src="'+m.icon.options.iconUrl+'" /> <span>'+m.name+"</span></a></li>")})),$("#menu ul li a").on("click",(function(e){e.preventDefault();var marker=$(this).data("debug-marker");debugMarkers.find((function(m){m.name===marker&&(m.marker.openPopup(),map.setView(unproject([m.coords[0],m.coords[1]]),5),console.log(m))}))})),groups.forEach((function(e){map.addLayer(window[e+"Group"])}))),map.on("popupopen",popUpOpen),$(document).ready((function(){var updateDiscord,w;if(!localStorage.getItem("update-discord")){var lightbox=lity("#update-discord");localStorage.setItem("update-discord","1")}$.get("api/user",(function(res){void 0!==res.users&&$("#total-users").text(res.users),void 0!==res.visits&&$("#total-visits").text(res.visits),void 0!==res.login&&($("#discord").attr("href",res.login).attr("target",window.location!==window.parent.location?"_blank":"_self"),initMarkers()),void 0!==res.uid&&($("#discord").toggleClass("bg-indigo-400 bg-white text-white text-gray-900 border-indigo-400 border-gray-400 text-xs").html('<img src="'+res.avatar+'" onerror="this.src=\''+res.avatar_default+'\'" class="mr-2 h-6 rounded-full" /><strong>'+res.username+"</strong>").attr("href",res.logout),userLocal=!1,userMarkers=res.markers,initMarkers(),res.menu&&($(res.menu).each((function(key,type){void 0!==window[type+"Group"]&&($('#menu a[data-type="'+type+'"]').addClass("active"),map.addLayer(window[type+"Group"]),menuActive.push(type))})),updateislandmarkersinit()))})),window.innerWidth<=500&&($("body").removeClass("show-menu"),map.invalidateSize());var zoom=params.z&&["2","3","4"].indexOf(params.z)>=0?params.z:4;if(params.x&&params.y?map.setView(unproject([params.x,params.y]),zoom):params.z&&map.setZoom(zoom),params.markers){var pmarkers=params.markers.split(",");window.menuActive=[],groups.forEach((function(e){map.removeLayer(window[e+"Group"])})),pmarkers.forEach((function(e){void 0!==window[e+"Group"]&&($('#menu a[data-type="'+e+'"]').addClass("active"),map.addLayer(window[e+"Group"]),window.menuActive.push(e))})),updateislandmarkersinit()}params["hide-menu"]&&($("body").removeClass("show-menu"),map.invalidateSize()),$(document).on("change",'input[type="checkbox"]',(function(){userLocal?saveUserMarkers($(this).data("id"),$(this).is(":checked")):saveUserMarker($(this).data("id"),$(this).is(":checked"))})),$(document).on("change",'input[type="radio"]',(function(){var ileId=$(this).data("id"),ilever=$(this).data("ver");old=window["old"+ileId],window["imageOverlay"+ileId+old].removeFrom(map),window["imageOverlay"+ileId+ilever].addTo(map),updateislandmarkers(ileId,ilever,old),window["old"+ileId]=ilever,currentMarker.closePopup()})),$("#menu a[data-type]").on("click",(function(e){e.preventDefault();var type=$(this).data("type");$(this).hasClass("active")?(map.removeLayer(window[type+"Group"]),window.menuActive.splice(window.menuActive.indexOf(type),1),updateislandmarkersmenu(type,!1),userLocal||$.post("api/removemenu/"+type)):(map.addLayer(window[type+"Group"]),window.menuActive.push(type),updateislandmarkersmenu(type,!0),userLocal||$.post("api/addmenu/"+type)),$(this).toggleClass("active")}))}));