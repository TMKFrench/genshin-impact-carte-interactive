function onMapClick(e){console.log("Position @ "+map.project([e.latlng.lat,e.latlng.lng],map.getMaxZoom())),console.log("Point @ ["+e.latlng.lat+", "+e.latlng.lng+"]")}function unproject(coord){return map.unproject(coord,map.getMaxZoom())}function updateCurrentMarker(){currentMarker=this}function updateUserCountdowns(checked){var countdowns=getUserCountdowns();if(void 0!==currentMarker._tooltip&&"countdown"===currentMarker._tooltip.options.className){var cid=currentMarker._tooltip.options.countdownid;if(checked){var nextTime=moment();nextTime.add(currentMarker._tooltip.options.countdown,"hours"),currentMarker._tooltip.setContent('<div id="countdown-'+currentMarker._tooltip.options.countdownid+'">Prochain reset :</div>'),$($("#countdown-"+currentMarker._tooltip.options.countdownid)).countdown(nextTime.toDate(),(function(event){var totalDays;"finish"===event.type?(resetCountdown(cid),$(this).html("")):7*event.offset.weeks+event.offset.days>0?$(this).html("Prochain reset :<br />"+event.strftime("%-D j. %H:%M:%S")):$(this).html("Prochain reset :<br />"+event.strftime("%H:%M:%S"))})),searchId(cid,countdowns)<=0&&countdowns.push({id:cid,date:nextTime.format("YYYY-MM-DD HH:mm:ss")})}else{var i=searchId(cid,countdowns);i>=0&&countdowns.splice(i,1),currentMarker._tooltip.setContent('<div id="countdown-'+currentMarker._tooltip.options.countdownid+'"></div>')}localStorage.setItem("userCountdowns",JSON.stringify(countdowns)),userCountdowns=JSON.stringify(countdowns)}}function saveUserMarker(uid,checked){var markers=getUserMarkers();updateUserCountdowns(checked),checked?$.post("api/addmarker/"+uid,(function(res){void 0!==res.error&&(alert("Vous avez été déconnecté. La page va se rafraîchir."),window.location.reload()),currentMarker.setOpacity(.5),userMarkers=res.markers})):$.post("api/removemarker/"+uid,(function(res){void 0!==res.error&&(alert("Vous avez été déconnecté. La page va se rafraîchir."),window.location.reload()),currentMarker.setOpacity(1),userMarkers=res.markers}))}function searchId(nameKey,myArray){for(var i=0;i<myArray.length;i++)if(myArray[i].id===nameKey)return i;return-1}function resetCountdown(cid){var markers=getUserMarkers(),countdowns=getUserCountdowns(),i=searchId(cid,countdowns);i>=0&&(allMarkers[cid].setOpacity(1),countdowns.splice(i,1)),markers.indexOf(cid)>=0&&markers.splice(markers.indexOf(cid),1),localStorage.setItem("userCountdowns",JSON.stringify(countdowns)),userCountdowns=JSON.stringify(countdowns),localStorage.setItem("userMarkers",JSON.stringify(markers)),userMarkers=JSON.stringify(markers)}function saveUserMarkers(uid,checked){var markers=getUserMarkers();updateUserCountdowns(checked),checked?(markers.indexOf(uid)<0&&markers.push(uid),currentMarker.setOpacity(.5)):(markers.indexOf(uid)>=0&&markers.splice(markers.indexOf(uid),1),currentMarker.setOpacity(1)),localStorage.setItem("userMarkers",JSON.stringify(markers)),userMarkers=JSON.stringify(markers)}function getUserCountdowns(){var countdowns=localStorage.getItem("userCountdowns");return countdowns=countdowns?JSON.parse(countdowns):[]}function getUserMarkers(){var markers=localStorage.getItem("userMarkers");return markers=markers?JSON.parse(markers):[]}function getParamsURL(){var url,query=location.search.substr(1),result={};return query.split("&").forEach((function(part){var item=part.split("=");result[item[0]]=decodeURIComponent(item[1])})),result}function popUpOpen(e){var content=e.popup.getContent();$(content).find("input#user-marker").length>0&&userMarkers.indexOf($(content).find("input#user-marker").first().data("id"))>=0&&$('input#user-marker[data-id="'+$(content).find("input#user-marker").first().data("id")+'"]').prop("checked","checked")}var currentMarker,total=0,params=getParamsURL(),userMarkers=getUserMarkers(),userCountdowns=getUserCountdowns(),debugMarkers=[],userLocal=!0,allMarkers=[],map=new L.Map("map",{center:[5,-15],zoom:3,zoomControl:!1});L.tileLayer("assets/img/tiles-chasm/{z}/{x}/{y}.jpg",{attribution:'<a href="https://gaming.lebusmagique.fr">Le Bus Magique Gaming</a>',maxZoom:4,minZoom:2,continuousWorld:!0,maxBoundsViscosity:.8,noWrap:!0}).addTo(map);var toolbarZoom=L.easyBar([L.easyButton('<img src="assets/img/plus.png" alt="Zoom+" title="Zoomer sur la carte">',(function(control,map){map.setZoom(map.getZoom()+1)})),L.easyButton('<img src="assets/img/minus.png" alt="Zoom-" title="Dézoomer sur la carte">',(function(control,map){map.setZoom(map.getZoom()-1)}))]),toolbarMenu=L.easyBar([L.easyButton('<img src="assets/img/menu.png" alt="Menu" title="Afficher/Masquer le menu">',(function(control,map){$("body").toggleClass("show-menu"),map.invalidateSize()}))]),toolbarRegion=L.easyBar([L.easyButton('<img src="assets/img/region.png" alt="Region" title="Afficher/Masquer le nom des régions">',(function(control,map){map.hasLayer(regionGroup)?map.removeLayer(regionGroup):map.addLayer(regionGroup)}))]),toolbarResetMarkers=L.easyBar([L.easyButton('<img src="assets/img/reset.png" alt="Réinitialiser" title="Réinitialiser le suivi de vos marqueurs">',(function(control,map){confirm("Êtes-vous sûr de vouloir supprimer le suivi de vos marqueurs ?")&&(userLocal?(localStorage.removeItem("userMarkers"),localStorage.removeItem("userCountdowns"),window.location.reload()):$.post("api/resetmarkers",(function(res){void 0!==res.error&&alert("Vous avez été déconnecté. La page va se rafraîchir."),localStorage.removeItem("userMarkers"),localStorage.removeItem("userCountdowns"),window.location.reload()})))}))]),toolbarInfo=L.easyBar([L.easyButton('<img src="assets/img/info.png">',(function(control,map){var lightbox=lity("#info")}))]);function initMarkers(){markers.forEach((function(g){g.markers.forEach((function(m){var checkbox="",icon,format,title="",text="",guide="",countdown,timer,finished=!1,color="#3388ff",region;(void 0!==m.checkbox&&m.checkbox||void 0!==g.checkbox&&g.checkbox)&&(checkbox='<label><input type="checkbox" id="user-marker" data-id="chasm'+g.id+m.id+'" /><span>Terminé</span></label>'),void 0!==g.text&&(text="<p>"+g.text+"</p>"),void 0!==m.text&&(text="<p>"+m.text+"</p>"),void 0!==g.title&&(title="<h4>"+g.title+"</h4>"),void 0!==m.title&&(title="<h4>"+m.title+"</h4>"),void 0!==g.guide&&(guide='<a href="'+g.guide+'" class="guide" target="_blank">Guide</a>'),void 0!==m.guide&&(guide=void 0!==g.guide&&"#"===m.guide.substr(0,1)?'<a href="'+g.guide+m.guide+'" class="guide" target="_blank">Guide</a>':'<a href="'+m.guide+'" class="guide" target="_blank">Guide</a>'),icon=void 0!==m.icon?m.icon:g.icon,format=void 0!==m.format?m.format:g.format,void 0!==g.countdown&&(countdown=g.countdown),void 0!==m.countdown&&(countdown=m.countdown),void 0!==g.timer&&(timer=g.timer),void 0!==m.timer&&(timer=m.timer),void 0!==g.color&&(color=g.color),void 0!==m.color&&(color=m.color),region=void 0!==g.region?g.region:void 0!==m.region?m.region:"base";var marker=L.marker(unproject([m.coords[0],m.coords[1]]),{icon:icon,riseOnHover:!0});if("popup"===format?marker.bindPopup(title+text+guide+checkbox):"video"===format?marker.bindPopup(title+'<a class="video" href="//www.youtube.com/watch?v='+m.video+'" data-lity><img src="https://i.ytimg.com/vi/'+m.video+'/hqdefault.jpg" /></a>'+text+guide+checkbox):"image"===format?marker.bindPopup(title+'<a href="assets/img/medias/chasm'+g.id+m.id+'.jpg" class="image" data-lity><img src="thumb/chasm'+g.id+m.id+'" /></a>'+text+guide+checkbox):"banner"===format?marker.bindPopup(title+'<img src="assets/img/medias/chasm'+g.id+m.id+'.jpg" onerror="this.src=\'assets/img/medias/default.jpg\'" />'+text+guide+checkbox):"region"===format?marker.bindTooltip(m.title,{permanent:!0,className:"region",offset:[0,13],direction:"top"}).openTooltip():"todo"===format?marker.bindPopup("<h4>chasm"+g.id+m.id+"</h4><p><em>Information pour ce marqueur prochainement disponible...</em></p>"+checkbox):"gif"===format&&marker.bindPopup(title+'<a href="assets/img/medias/chasm'+g.id+m.id+'.gif" class="image" data-lity><img src="assets/img/medias/chasm'+g.id+m.id+'.gif" /></a>'+text+guide+checkbox),void 0!==timer){var nextTime=moment();nextTime.get("hour")>=4&&nextTime.add(1,"day"),nextTime.set({hour:4,minute:0,second:0,millisecond:0}),marker.bindTooltip('<div id="timer-'+g.id+m.id+'">Prochain reset :</div>',{timerid:g.id+m.id,timer:nextTime.toDate(),permanent:!0,className:"timer",offset:[0,0],direction:"bottom"}).openTooltip(),marker.on("tooltipopen",(function(e){$($("#timer-"+e.tooltip.options.timerid)).countdown(e.tooltip.options.timer,(function(event){$(this).html("Prochain reset :<br />"+event.strftime("%H:%M:%S"))}))}))}if(void 0!==countdown){marker.bindTooltip("",{countdownid:g.id+m.id,countdown:countdown,permanent:!0,className:"countdown",offset:[0,10],direction:"bottom"}).openTooltip();var i=searchId(g.id+m.id,userCountdowns);i>=0&&(marker._tooltip.setContent('<div id="countdown-'+g.id+m.id+'">Prochain reset :</div>'),marker.on("tooltipopen",(function(e){$($("#countdown-"+g.id+m.id)).countdown(userCountdowns[i].date,(function(event){var totalDays;"finish"===event.type?(resetCountdown(g.id+m.id),$(this).html("")):7*event.offset.weeks+event.offset.days>0?$(this).html("Prochain reset :<br />"+event.strftime("%-D j. %H:%M:%S")):$(this).html("Prochain reset :<br />"+event.strftime("%H:%M:%S"))}))})))}if(checkbox&&marker.on("click",updateCurrentMarker),void 0!==m.polygon)var polygon=L.polygon(m.polygon,{color:color,fillColor:color}).addTo(g.group);marker.addTo(g.group),total++,userMarkers.indexOf("chasm"+g.id+m.id)>=0&&marker.setOpacity(.5),params.debug&&"region"!==g.id&&debugMarkers.push({name:g.id+m.id,marker:marker,coords:m.coords,icon:icon}),allMarkers[g.id+m.id]=marker}))})),$("#total").text(total)}toolbarZoom.addTo(map),toolbarMenu.addTo(map),toolbarRegion.addTo(map),toolbarResetMarkers.addTo(map),toolbarInfo.addTo(map),map.setMaxBounds(new L.LatLngBounds(unproject([0,0]),unproject([4096,4096]))),map.on("click",onMapClick),groups.forEach((function(e){map.removeLayer(window[e+"Group"])})),params.debug&&(initMarkers(),$("#menu ul").html(""),debugMarkers.forEach((function(m,k){$("#menu ul").append('<li class="marker col-span-2"><a href="#" data-debug-marker="'+m.name+'" class="active"><img src="'+m.icon.options.iconUrl+'" /> <span>'+m.name+"</span></a></li>")})),$("#menu ul li a").on("click",(function(e){e.preventDefault();var marker=$(this).data("debug-marker");debugMarkers.find((function(m){m.name===marker&&(m.marker.openPopup(),map.setView(unproject([m.coords[0],m.coords[1]]),5),console.log(m))}))})),groups.forEach((function(e){map.addLayer(window[e+"Group"])}))),map.on("popupopen",popUpOpen),$(document).ready((function(){var w;$.get("api/user",(function(res){void 0!==res.users&&$("#total-users").text(res.users),void 0!==res.visits&&$("#total-visits").text(res.visits),void 0!==res.login&&($("#discord").attr("href",res.login).attr("target",window.location!==window.parent.location?"_blank":"_self"),initMarkers()),void 0!==res.uid&&($("#discord").toggleClass("bg-indigo-400 bg-white text-white text-gray-900 border-indigo-400 border-gray-400 text-xs").html('<img src="'+res.avatar+'" onerror="this.src=\''+res.avatar_default+'\'" class="mr-2 h-6 rounded-full" /><strong>'+res.username+"</strong>").attr("href",res.logout),userLocal=!1,userMarkers=res.markers,initMarkers(),res.menu&&$(res.menu).each((function(key,type){void 0!==window[type+"Group"]&&($('#menu a[data-type="'+type+'"]').addClass("active"),map.addLayer(window[type+"Group"]))})))})),window.innerWidth<=500&&($("body").removeClass("show-menu"),map.invalidateSize());var zoom=params.z&&["2","3","4"].indexOf(params.z)>=0?params.z:4,pmarkers;(params.x&&params.y?map.setView(unproject([params.x,params.y]),zoom):params.z&&map.setZoom(zoom),params.markers)&&params.markers.split(",").forEach((function(e){void 0!==window[e+"Group"]&&($('#menu a[data-type="'+e+'"]').addClass("active"),map.addLayer(window[e+"Group"]))}));params["hide-menu"]&&($("body").removeClass("show-menu"),map.invalidateSize()),$(document).on("change",'input[type="checkbox"]',(function(){userLocal?saveUserMarkers($(this).data("id"),$(this).is(":checked")):saveUserMarker($(this).data("id"),$(this).is(":checked"))})),$("#menu a[data-type]").on("click",(function(e){e.preventDefault();var type=$(this).data("type");$(this).hasClass("active")?(map.removeLayer(window[type+"Group"]),userLocal||$.post("api/removemenu/"+type)):(map.addLayer(window[type+"Group"]),userLocal||$.post("api/addmenu/"+type)),$(this).toggleClass("active")}))}));